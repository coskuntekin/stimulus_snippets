<div class="highlight"><pre class="highlight ruby"><code><span class="no">ActionView</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">field_error_proc</span> <span class="o">=</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">html_tag</span><span class="p">,</span> <span class="n">instance</span><span class="o">|</span>
  <span class="n">form_fields</span> <span class="o">=</span> <span class="sx">%w[textarea input select]</span>
  <span class="n">tag_elements</span> <span class="o">=</span> <span class="no">Nokogiri</span><span class="o">::</span><span class="no">HTML</span><span class="o">::</span><span class="no">DocumentFragment</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">html_tag</span><span class="p">).</span><span class="nf">css</span> <span class="s1">'label, '</span> <span class="o">+</span> <span class="n">form_fields</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span>

  <span class="n">tag_elements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">element</span><span class="o">|</span>
    <span class="k">if</span> <span class="n">element</span><span class="p">.</span><span class="nf">node_name</span><span class="p">.</span><span class="nf">eql?</span> <span class="s1">'label'</span>
      <span class="n">html_tag</span> <span class="o">=</span> <span class="n">element</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">html_safe</span>
    <span class="k">elsif</span> <span class="n">form_fields</span><span class="p">.</span><span class="nf">include?</span> <span class="n">element</span><span class="p">.</span><span class="nf">node_name</span>
      <span class="n">field_error_message</span> <span class="o">=</span> <span class="n">instance</span><span class="p">.</span><span class="nf">error_message</span><span class="p">.</span><span class="nf">is_a?</span><span class="p">(</span><span class="no">Array</span><span class="p">)</span> <span class="p">?</span> <span class="n">instance</span><span class="p">.</span><span class="nf">error_message</span><span class="p">.</span><span class="nf">uniq</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">', '</span><span class="p">)</span> <span class="p">:</span> <span class="n">instance</span><span class="p">.</span><span class="nf">error_message</span>
      <span class="n">field_error_message</span> <span class="o">=</span> <span class="n">field_error_message</span><span class="p">.</span><span class="nf">to_s</span><span class="p">.</span><span class="nf">delete!</span><span class="p">(</span><span class="s1">'[]""'</span><span class="p">).</span><span class="nf">downcase</span>
      <span class="n">element</span><span class="p">[</span><span class="s1">'class'</span><span class="p">]</span> <span class="o">=</span> <span class="sx">%(#{element['class']} form__input--error)</span>
      <span class="n">element</span><span class="p">[</span><span class="s1">'aria-invalid'</span><span class="p">]</span> <span class="o">=</span> <span class="sx">%(#{element['aria-invalid']}true)</span>
      <span class="n">element</span><span class="p">[</span><span class="s1">'data-message'</span><span class="p">]</span> <span class="o">=</span> <span class="sx">%(#{element['data-message']}#{field_error_message})</span>
      <span class="n">html_tag</span> <span class="o">=</span> <span class="sx">%(#{element})</span><span class="p">.</span><span class="nf">html_safe</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">html_tag</span>
<span class="k">end</span>
</code></pre></div>